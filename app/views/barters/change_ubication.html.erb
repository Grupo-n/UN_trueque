<% content_for :head do %>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCvbcyIqQk5U9SJvT1I801xHm7e9zF_0E8&callback=initMap"></script>
<script src="https://cdn.rawgit.com/mahnunchik/markerclustererplus/master/dist/markerclusterer.min.js"></script>
<script src='https://cdn.rawgit.com/printercu/google-maps-utility-library-v3-read-only/master/infobox/src/infobox_packed.js' type='text/javascript'></script>
<!-- only if you need custom infoboxes -->
<%= javascript_include_tag "map"%>
<% end %>

<div class="container mt">
  <div class="row">
    <div class="col-sm-6">
      <!--%= image_tag "http://maps.google.com/maps/api/staticmap?size=450x300&sensor=false&zoom=16&markers=#{@barter.latitude}%2C#{@barter.longitude}" %-->
      <div class="full-width" style=''>
        <div id="map" class="full-width" style='height: 400px'></div>
      </div>
    </div>
    <div class="col-sm-6">
      <div class="panel panel-default">

        <div class="panel-heading">
          <h2 class="myhnot">Cambia ubicacion de encuentro</h2>
        </div>

        <div class="panel-body" style="height:270px">
          <h4 class="parrafo">
            Si estas de acuerdo con esta lugar, presiona acepta, de lo contrario, selecciona la ubicacion dando click en el lugar que desees.
            <strong>Cuando ambos participantes de la transaccion acepten, el intercambio sera concretado</strong>
          </h4>
        </div>

        <div class="panel-footer container-fluid">
          <%= form_for @barter do |b| %>
          <%= b.hidden_field :accept_user_one, :value => 'false' %>
          <%= b.hidden_field :accept_user_two, :value => 'false' %>
          <%= b.hidden_field :latitude , id:"barter_latitude"%>
          <%= b.hidden_field :longitude, id: "barter_longitude" %>
          <% @barter.meeting_date < Time.now ? $date = Time.now.strftime("%Y-%m-%d") : $date = @barter.meeting_date %>
          <%= b.date_field :meeting_date, :value => $date %>
          <% @barter.meeting_time < Time.now ? $time = Time.now : $time = @barter.meeting_time %>
          <%= b.time_field :meeting_time, :value => Time.now.strftime("%h-%m")  %>
          <!--%= datetime_local_field(:user, :graduation_day) %-->
          <%= b.submit 'Aceptar', class: 'btn btn-default btn-right' %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
var marker;
var handler;
var mapStyle = [

  {
        "featureType": "all",
        "elementType": "labels.text.fill",
        "stylers": [
            {
                "color": "#ffffff"
            }
        ]
    },
    {
        "featureType": "all",
        "elementType": "labels.text.stroke",
        "stylers": [
            {
                "color": "#000000"
            },
            {
                "lightness": 13
            }
        ]
    },
    {
        "featureType": "administrative",
        "elementType": "geometry.fill",
        "stylers": [
            {
                "color": "#000000"
            }
        ]
    },
    {
        "featureType": "administrative",
        "elementType": "geometry.stroke",
        "stylers": [
            {
                "color": "#144b53"
            },
            {
                "lightness": 14
            },
            {
                "weight": 1.4
            }
        ]
    },
    {
        "featureType": "landscape",
        "elementType": "all",
        "stylers": [
            {
                "color": "#08304b"
            }
        ]
    },
    {
        "featureType": "poi",
        "elementType": "geometry",
        "stylers": [
            {
                "color": "#0c4152"
            },
            {
                "lightness": 5
            }
        ]
    },
    {
        "featureType": "road.highway",
        "elementType": "geometry.fill",
        "stylers": [
            {
                "color": "#000000"
            }
        ]
    },
    {
        "featureType": "road.highway",
        "elementType": "geometry.stroke",
        "stylers": [
            {
                "color": "#0b434f"
            },
            {
                "lightness": 25
            }
        ]
    },
    {
        "featureType": "road.arterial",
        "elementType": "geometry.fill",
        "stylers": [
            {
                "color": "#000000"
            }
        ]
    },
    {
        "featureType": "road.arterial",
        "elementType": "geometry.stroke",
        "stylers": [
            {
                "color": "#0b3d51"
            },
            {
                "lightness": 16
            }
        ]
    },
    {
        "featureType": "road.local",
        "elementType": "geometry",
        "stylers": [
            {
                "color": "#000000"
            }
        ]
    },
    {
        "featureType": "transit",
        "elementType": "all",
        "stylers": [
            {
                "color": "#146474"
            }
        ]
    },
    {
        "featureType": "water",
        "elementType": "all",
        "stylers": [
            {
                "color": "#021019"
            }
        ]
    }


];

function initMap(){
  marker;
  handler = Gmaps.build('Google');
  handler.buildMap({ internal: {id: 'map'},
   provider: {
        zoom:      15,
        center:    new google.maps.LatLng(4.635487, -74.082719),
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        styles:    mapStyle
      }


  }, function(){

      marker = handler.addMarker({
        lat: document.getElementById('barter_latitude').value ,
        lng: document.getElementById('barter_longitude').value
      });
      handler.map.centerOn(marker);
  });

  function displayOnMap(position){
    marker = handler.addMarker({
      lat: position.coords.latitude,
      lng: position.coords.longitude
    });
    handler.map.centerOn(marker);


  };

  google.maps.event.addListener(handler.getMap(), "click", function(evt) {
    handler.removeMarker(marker);
    document.getElementById('barter_latitude').value = evt.latLng.lat();
    document.getElementById('barter_longitude').value = evt.latLng.lng();
    marker = handler.addMarker({
      lat: evt.latLng.lat(),
      lng: evt.latLng.lng()
    });
    handler.map.centerOn(marker);
    evt.stop();
  });
}
</script>
